<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to `threemc` • threemc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to `threemc`">
<meta property="og:description" content="threemc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">threemc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.40</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01_intro.html">Introduction to `threemc`</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/threemc/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="01_intro_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to <code>threemc</code>
</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/threemc/blob/HEAD/vignettes/01_intro.Rmd" class="external-link"><code>vignettes/01_intro.Rmd</code></a></small>
      <div class="hidden name"><code>01_intro.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette serves as an introduction to <code>threemc</code> (or “Matt’s model for male circumcision”), a Bayesian multilevel spatio-temporal, competing-risks, time-to-event model for, unsurprisingly, male circumcision. It models the circumcision rate, but also computes circumcision incidence and cumulative incidence (i.e. circumcision coverage) <span class="citation">[1]</span>.</p>
<p>Circumcision is split between two types (which form our “competing-risks”, along with being uncircumcised), medical male circumcision (MMC) and traditional male circumcision (TMC). The model is stratified by age, location and time, and also includes interaction terms between these variables.</p>
<p><code>threemc</code> is implemented in Template Model Builder (<code>TMB</code>). TMB is an R package that enables users to flexibly fit latent process/variable models to data. It uses automatic differentiation and Laplace approximations to estimate posterior distributions for model parameters. The objective function produced by <code>TMB</code> can be called in R, and so can be optimised using e.g. <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">stats::nlminb</a></code>. <code>TMB</code> is particularly fast in comparison to other methods (e.g. INLA) when there are many random effects, such as are commonly found in spatio-temporal models like <code>threemc</code>. <span class="citation">[1,2]</span>.</p>
<p>We will go through a simple <code>threemc</code> model of an example dataset for Malawi. It’s important to note that <strong>we only look at a subset of Malawi’s surveys</strong> here (not all are publicly available), so <strong>our results are not reliable and shouldn’t be taken as genuine predictions</strong>.</p>
<p>First, load the prerequisite packages, which won’t be too many beyond <code>threemc</code> itself.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for analysis</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.10.2, GDAL 3.4.2, PROJ 8.2.1; sf_use_s2() is TRUE</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/threemc" class="external-link">threemc</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># for plotting</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org" class="external-link">scales</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Revert to using planar rather than spherical geometry in `sf`</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Spherical geometry (s2) switched off</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="metadata">Metadata<a class="anchor" aria-label="anchor" href="#metadata"></a>
</h2>
<p>Next, set the following metadata in our analysis:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cntry</span> <span class="op">&lt;-</span> <span class="st">"MWI"</span>          <span class="co"># iso3 code for country to model </span></span>
<span><span class="va">cens_age</span> <span class="op">&lt;-</span> <span class="fl">59</span>          <span class="co"># max circ. age to include in model, censor older ages</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">1000</span>               <span class="co"># N samples from posterior predictive distribution</span></span>
<span><span class="va">start_year</span> <span class="op">&lt;-</span> <span class="fl">2008</span>      <span class="co"># year to begin predictions </span></span>
<span><span class="va">forecast_year</span> <span class="op">&lt;-</span> <span class="fl">2021</span>   <span class="co"># predictions up to this year</span></span>
<span></span>
<span><span class="co"># PSNU area level for modelled country</span></span>
<span><span class="va">area_lev</span> <span class="op">&lt;-</span> <span class="fu">threemc</span><span class="fu">::</span><span class="va"><a href="../reference/datapack_psnu_area_level.html">datapack_psnu_area_level</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">iso3</span> <span class="op">==</span> <span class="va">cntry</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">psnu_area_level</span><span class="op">)</span></span>
<span><span class="va">area_lev</span></span>
<span><span class="co">#&gt; [1] 5</span></span></code></pre></div>
<p>For this example, we will use the default “standard” <code>threemc</code> model, which does not include a time effect for TMC (i.e. it assumes that TMC practises don’t and won’t change over time), uses an AR 1 temporal process, and treats MMC for all ages as time varying. Models with these features will be introduced in a later vignette.</p>
<p>Note that <code>threemc</code> contains the dataset <code>datapack_psnu_area_level</code>, which contains the PSNU (“Primary Sampling Unit”) area level for surveys conducted in many Sub-saharan African countries. For Malawi, this is area level five, which corresponds to “Health District + Cities”. Each area level has a different meaning for each county, but in general, higher values correspond to more granular regions.</p>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>Next, we load our required datasets. Note that this data is normally loaded using <code>read_circ_data</code>, which avoids having to switch between <code><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">readr::read_csv</a></code> and <code><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">sf::read_sf</a></code>, and makes repeated filtering more terse. However, the demo data we will use in this analysis is directly included in <code>threemc</code>, so we just explicitly assign it to the global environment from there.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' # "Normal" data loading procedure (same for areas, surveys and pops)</span></span>
<span><span class="co">#' filters = c("iso3" = cntry, "sex" = male)</span></span>
<span><span class="co">#' survey_circumcision = read_circ_data(</span></span>
<span><span class="co">#'   path    = "path/to/survey_circumcision", </span></span>
<span><span class="co">#'   filters = filters</span></span>
<span><span class="co">#' ) </span></span>
<span><span class="va">survey_circumcision</span> <span class="op">&lt;-</span> <span class="fu">threemc</span><span class="fu">::</span><span class="va"><a href="../reference/demo_survey_circumcision.html">demo_survey_circumcision</a></span></span>
<span><span class="va">areas</span> <span class="op">&lt;-</span> <span class="fu">threemc</span><span class="fu">::</span><span class="va"><a href="../reference/demo_areas.html">demo_areas</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>space <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># Add unique identifier for each area</span></span>
<span><span class="va">populations</span> <span class="op">&lt;-</span> <span class="fu">threemc</span><span class="fu">::</span><span class="va"><a href="../reference/demo_populations.html">demo_populations</a></span></span></code></pre></div>
<p>For more information on these datasets and what they contain, please see their respective help files (using e.g. <code>help("demo_survey_circumcision)"</code>). If you wish to fit a model using <code>threemc</code> with your own data, it must include the same columns as these datasets.</p>
</div>
<div class="section level2">
<h2 id="prepare-survey-data">Prepare Survey Data<a class="anchor" aria-label="anchor" href="#prepare-survey-data"></a>
</h2>
<p>We now preprocess our survey data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># pull latest censoring year from survey_id</span></span>
<span><span class="va">survey_years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">survey_circumcision</span><span class="op">$</span><span class="va">survey_id</span><span class="op">)</span></span>
<span><span class="va">cens_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">survey_years</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prepare circ data, and normalise survey weights and apply Kish coefficients.</span></span>
<span><span class="va">survey_circ_preprocess</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_survey_data.html">prepare_survey_data</a></span><span class="op">(</span></span>
<span>  areas               <span class="op">=</span> <span class="va">areas</span>,</span>
<span>  survey_circumcision <span class="op">=</span> <span class="va">survey_circumcision</span>,</span>
<span>  area_lev            <span class="op">=</span> <span class="va">area_lev</span>,</span>
<span>  start_year          <span class="op">=</span> <span class="va">start_year</span>,</span>
<span>  cens_year           <span class="op">=</span> <span class="va">cens_year</span>,</span>
<span>  cens_age            <span class="op">=</span> <span class="va">cens_age</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Uncircumised/right censored (event 0)                  Uncensored (event 1) </span></span>
<span><span class="co">#&gt;                                 21642                                  6260 </span></span>
<span><span class="co">#&gt;               Left censored (event 2) </span></span>
<span><span class="co">#&gt;                                   248</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">survey_circ_preprocess</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 25</span></span></span>
<span><span class="co">#&gt;   iso3  survey_id  area_id  sex     age dob_cmc interv…¹ indwe…² circ_…³ circ_…⁴</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> MWI   MWI2010DHS MWI_5_22 male      7    <span style="text-decoration: underline;">1</span>146     <span style="text-decoration: underline;">1</span>327   0.730       1       6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> MWI   MWI2010DHS MWI_5_24 male      7    <span style="text-decoration: underline;">1</span>142     <span style="text-decoration: underline;">1</span>328   0.768       1       6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> MWI   MWI2010DHS MWI_5_33 male      8    <span style="text-decoration: underline;">1</span>144     <span style="text-decoration: underline;">1</span>327   4.98        1       7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> MWI   MWI2010DHS MWI_5_18 male      8    <span style="text-decoration: underline;">1</span>148     <span style="text-decoration: underline;">1</span>328   2.42        1       7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> MWI   MWI2010DHS MWI_5_21 male      8    <span style="text-decoration: underline;">1</span>135     <span style="text-decoration: underline;">1</span>326   1.42        1       7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> MWI   MWI2010DHS MWI_5_19 male      8    <span style="text-decoration: underline;">1</span>145     <span style="text-decoration: underline;">1</span>329   1.44        1       7</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 15 more variables: circ_who &lt;chr&gt;, circ_where &lt;chr&gt;, year &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   yob &lt;dbl&gt;, yoc &lt;dbl&gt;, area_name &lt;chr&gt;, area_level &lt;dbl&gt;, time1 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   time2 &lt;dbl&gt;, event &lt;dbl&gt;, type &lt;chr&gt;, indweight_st &lt;dbl&gt;, N &lt;int&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   Neff &lt;dbl&gt;, ratio &lt;dbl&gt;, and abbreviated variable names ¹​interview_cmc,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ²​indweight, ³​circ_status, ⁴​circ_age</span></span></span></code></pre></div>
<p>Amongst other things, <code>prepare_survey_data</code>:<br>
- Removes rows with missing essential information (e.g. circumcision status), and identifies surveys which are completely excluded due to missing data,<br>
- Censors circumcisions at <code>cens_age</code> and <code>cens_year</code>, for circumcision age and year, respectively,<br>
- sets the desired area level of aggregation for each survey, reassigning surveys at a more granular level to the specified <code>area_lev</code> (e.g. MWI_6_309 (STA Tombondiya), a “Traditional Authority” is reassigned to it’s “Health District + Cities”, MWI_5_22 (Mulanje)),<br>
- Identifies left (i.e. those circumcised at an unknown age, labelled with the column <code>event</code> == 1) and right (i.e. still uncircumcised, labelled with <code>event</code> == 2) censored individuals (those uncensored have <code>event</code> == 0),<br>
- Uses <code>circ_who</code> and <code>circ_where</code> to determine circumcision <code>type</code>,<br>
- Identifies surveys for which this type information is unavailable, and - normalises survey weights and applies the Kish coefficient.</p>
<p>In these Malawi surveys, we do see the presence of some left censoring, but thankfully every survey contains enough valid circumcision data to be used.</p>
</div>
<div class="section level2">
<h2 id="create-shell-dataset">Create Shell Dataset<a class="anchor" aria-label="anchor" href="#create-shell-dataset"></a>
</h2>
<p>We wish to make predictions for each unique combination of:<br>
- The <code>area_id</code>s in <code>survey_circ_preprocess</code>,<br>
- circumcision age 0-<code>max(survey_circ_preprocess$circ_age)</code>,<br>
- circumcision years from <code>start_year</code>-<code>forecast_year</code>, and<br>
- each type of circumcision (TMC, MMC and for “Missing” type, which can still be used when modelling Total MC).</p>
<p>To that end, we use <code>create_shell_dataset</code> to use our shapefiles and preprocessed surveys to create, well, a shell dataset!</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_shell_dataset.html">create_shell_dataset</a></span><span class="op">(</span></span>
<span>    survey_circumcision <span class="op">=</span> <span class="va">survey_circ_preprocess</span>,</span>
<span>    populations         <span class="op">=</span> <span class="va">populations</span>,</span>
<span>    areas               <span class="op">=</span> <span class="va">areas</span>,</span>
<span>    area_lev            <span class="op">=</span> <span class="va">area_lev</span>,</span>
<span>    start_year          <span class="op">=</span> <span class="va">start_year</span>,</span>
<span>    end_year            <span class="op">=</span> <span class="va">forecast_year</span>,</span>
<span>    time1               <span class="op">=</span> <span class="st">"time1"</span>,</span>
<span>    time2               <span class="op">=</span> <span class="st">"time2"</span>,</span>
<span>    strat               <span class="op">=</span> <span class="st">"space"</span>,</span>
<span>    age                 <span class="op">=</span> <span class="st">"age"</span>,</span>
<span>    circ                <span class="op">=</span> <span class="st">"indweight_st"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 15</span></span></span>
<span><span class="co">#&gt;   area_id area_n…¹ area_…² space  year circ_…³  time   age popul…⁴     N obs_mmc</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> MWI     Malawi         0     1  <span style="text-decoration: underline;">2</span>008       0     1     1 <span style="text-decoration: underline;">277</span>849      0       0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> MWI     Malawi         0     1  <span style="text-decoration: underline;">2</span>009       0     2     1 <span style="text-decoration: underline;">282</span>535.     0       0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> MWI     Malawi         0     1  <span style="text-decoration: underline;">2</span>010       0     3     1 <span style="text-decoration: underline;">284</span>753      0       0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> MWI     Malawi         0     1  <span style="text-decoration: underline;">2</span>011       0     4     1 <span style="text-decoration: underline;">285</span>406.     0       0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> MWI     Malawi         0     1  <span style="text-decoration: underline;">2</span>012       0     5     1 <span style="text-decoration: underline;">285</span>823.     0       0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> MWI     Malawi         0     1  <span style="text-decoration: underline;">2</span>013       0     6     1 <span style="text-decoration: underline;">286</span>093.     0       0</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 4 more variables: obs_tmc &lt;dbl&gt;, obs_mc &lt;dbl&gt;, cens &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   icens &lt;dbl&gt;, and abbreviated variable names ¹​area_name, ²​area_level,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ³​circ_age, ⁴​population</span></span></span></code></pre></div>
<p>For each of these unique combinations, <code>create_shell_dataset</code> also adds their respective <code>population</code> from <code>populations</code>, and calculates:<br>
- <code>N</code>, the person years, - <code>obs_mmc</code>, <code>obs_tmc</code> <code>obs_mc</code> (representing those with “Missing” circumcision type), <code>cens</code> and <code>icens</code>, the observed rate of circumcision for each circumcision type, - Also the rate of right-censoring (uncircumcised) and left-censoring (unknown circumcision age).</p>
</div>
<div class="section level2">
<h2 id="model-fit-matrices">Model Fit Matrices<a class="anchor" aria-label="anchor" href="#model-fit-matrices"></a>
</h2>
<p>The final step before fitting our model is to prepare our model data. The function <code>threemc_prepare_model_data</code> outputs a list, and calculates: - design matrices for fixed effects and temporal, age, space and interaction random effects, (the list elements with names beginning with <code>X_</code> below), - integration matrices for selecting the instantaneous hazard rate (The <code>IntMat</code>s),<br>
- survival matrices for MMC, TMC, censored and left censored, and (the matrices labelled “A” (for the various types of circumcision), <code>B</code> (for right-censoring) and <code>C</code> (for left-censoring)). - the precision/adjacency matrix for the spatial random effect (<code>Q_space</code>).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># prepare_dataset for modelling</span></span>
<span><span class="va">dat_tmb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/threemc_prepare_model_data.html">threemc_prepare_model_data</a></span><span class="op">(</span></span>
<span>    out      <span class="op">=</span> <span class="va">out</span>,</span>
<span>    areas    <span class="op">=</span> <span class="va">areas</span>,</span>
<span>    area_lev <span class="op">=</span> <span class="va">area_lev</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; although coordinates are longitude/latitude, st_intersects assumes that they</span></span>
<span><span class="co">#&gt; are planar</span></span>
<span><span class="co">#&gt; Warning: as(&lt;matrix&gt;, "dgTMatrix") is deprecated since Matrix 1.5-0; do</span></span>
<span><span class="co">#&gt; as(as(as(., "dMatrix"), "generalMatrix"), "TsparseMatrix") instead</span></span>
<span><span class="co">#&gt; rw_order = NULL, AR 1 temporal prior specified</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat_tmb</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "X_fixed_mmc"     "X_fixed_tmc"     "X_time_mmc"      "X_age_mmc"      </span></span>
<span><span class="co">#&gt;  [5] "X_age_tmc"       "X_space_mmc"     "X_space_tmc"     "X_agetime_mmc"  </span></span>
<span><span class="co">#&gt;  [9] "X_agespace_mmc"  "X_agespace_tmc"  "X_spacetime_mmc" "IntMat1"        </span></span>
<span><span class="co">#&gt; [13] "IntMat2"         "A_mmc"           "A_tmc"           "A_mc"           </span></span>
<span><span class="co">#&gt; [17] "B"               "C"               "Q_space"         "type_info"</span></span></code></pre></div>
<p>The message returned by <code>threemc_prepare_model_data</code> informs us that we have implicitly chosen an AR 1 temporal prior here because we have not specified the <code>rw_order</code> parameter.</p>
</div>
<div class="section level2">
<h2 id="fit-model">Fit Model<a class="anchor" aria-label="anchor" href="#fit-model"></a>
</h2>
<p>Now we can finally fit our model.</p>
<p>First, we initialise hyperparameter values using <code>threemc_initial_pars</code>. This uses the matrices in <code>dat_tmb</code> to create a named list of the initial hyperparameters needed for our <code>threemc</code> model. The defaults can be overridden by specifying the <code>custom_init</code> parameter with a named list of it’s own.</p>
<p>Next, we run <code>threemc_fit_model</code>, which uses <code><a href="https://rdrr.io/pkg/TMB/man/MakeADFun.html" class="external-link">TMB::MakeADFun</a></code> to create an objective function (the negative log-likelihood) which can then be optimised by <code>nlminb</code> using BFGS. Using Monte Carlo sampling, we also draw <code>N</code> samples from the joint posterior distribution, conditional on the optimised hyperparameters <span class="citation">[3]</span>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Initialise `threemc` hyperparameters</span></span>
<span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/threemc_initial_pars.html">threemc_initial_pars</a></span><span class="op">(</span><span class="va">dat_tmb</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fit model with TMB and stats::nlminb optimiser</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/threemc_fit_model.html">threemc_fit_model</a></span><span class="op">(</span></span>
<span>    dat_tmb    <span class="op">=</span> <span class="va">dat_tmb</span>,</span>
<span>    parameters <span class="op">=</span> <span class="va">parameters</span>,</span>
<span>    randoms    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"u_time_mmc"</span>, <span class="st">"u_age_mmc"</span>, <span class="st">"u_age_mmc_paed"</span>, <span class="st">"u_space_mmc"</span>,</span>
<span>        <span class="st">"u_agetime_mmc"</span>, <span class="st">"u_agespace_mmc"</span>, <span class="st">"u_agespace_mmc_paed"</span>,</span>
<span>        <span class="st">"u_spacetime_mmc"</span>,</span>
<span>        <span class="st">"u_time_tmc"</span>, <span class="st">"u_age_tmc"</span>, <span class="st">"u_space_tmc"</span>, <span class="st">"u_agespace_tmc"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    N          <span class="op">=</span> <span class="va">N</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; mod not supplied, mod used = Surv_SpaceAgeTime_ByType_withUnknownType</span></span>
<span><span class="co">#&gt; Creating TMB object with `TMB::MakeADFun`...</span></span>
<span><span class="co">#&gt; Optimising...</span></span>
<span><span class="co">#&gt; Warning in stats::nlminb(start = obj$par, obj = obj$fn, gr = obj$gr, control =</span></span>
<span><span class="co">#&gt; list(trace = 1), : NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; Sampling...</span></span></code></pre></div>
<!-- fit <- readRDS(file = "MWI_TMBObjects_DistrictAgeTime_ByType.rds") -->
<p>Be aware that this can take quite a long time. Just think of all the random effects, and interactions between these! You can model using lower <code>area_lev</code> for a faster fit time in a pinch.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "par"         "objective"   "convergence" "iterations"  "evaluations"</span></span>
<span><span class="co">#&gt;  [6] "message"     "par.fixed"   "par.full"    "obj"         "sample"</span></span></code></pre></div>
<p><code>fit</code> contains all the expected outputs from supplying <code><a href="https://rdrr.io/pkg/TMB/man/MakeADFun.html" class="external-link">TMB::MakeADFun</a></code> objective function to <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">stats::nlminb</a></code>. Among other things, we can have a look at the optimised hyperparameters for our model:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">$</span><span class="va">par</span></span>
<span><span class="co">#&gt;            u_fixed_mmc            u_fixed_tmc       logsigma_age_mmc </span></span>
<span><span class="co">#&gt;             -5.7829722             -8.3052738              0.2216365 </span></span>
<span><span class="co">#&gt;      logsigma_time_mmc     logsigma_space_mmc   logsigma_agetime_mmc </span></span>
<span><span class="co">#&gt;              0.4135557              0.3337643             -0.6627453 </span></span>
<span><span class="co">#&gt;  logsigma_agespace_mmc logsigma_spacetime_mmc       logsigma_age_tmc </span></span>
<span><span class="co">#&gt;             -0.6955086             -1.6808744              0.9233108 </span></span>
<span><span class="co">#&gt;     logsigma_space_tmc  logsigma_agespace_tmc     logitrho_mmc_time1 </span></span>
<span><span class="co">#&gt;              0.4696310              1.2423358              2.9700754 </span></span>
<span><span class="co">#&gt;     logitrho_mmc_time2     logitrho_mmc_time3      logitrho_mmc_age1 </span></span>
<span><span class="co">#&gt;              9.2987679            -12.7145536              2.1412024 </span></span>
<span><span class="co">#&gt;      logitrho_mmc_age2      logitrho_mmc_age3      logitrho_tmc_age1 </span></span>
<span><span class="co">#&gt;             -5.1282586            -12.7144787              0.7570581 </span></span>
<span><span class="co">#&gt;      logitrho_tmc_age2 </span></span>
<span><span class="co">#&gt;             -5.3282535</span></span></code></pre></div>
<p>Here <code>logsigma</code> and <code>logitrho</code> refer to variance and covariance hyperparameters, respectively.</p>
<p>We can also access <code>N</code> samples from the posterior predictive distribution for the following quantities:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "inc_mc"      "inc_mmc"     "haz_tmc"     "cum_inc_mmc" "haz_mmc"    </span></span>
<span><span class="co">#&gt;  [6] "surv_mc"     "cum_inc_mc"  "cum_inc_tmc" "inc_tmc"     "haz_mc"</span></span></code></pre></div>
<ul>
<li>
<code>"rate_mmc", "rate_tmc", "rate", "surv"</code> refer to the circumcision rates,<br>
</li>
<li>
<code>"inc_mmc", "inc_tmc", "inc"</code>, refer to the (non-cumulative) circumcision incidence, and<br>
</li>
<li>
<code>"cum_inc_mmc", "cum_inc_tmc", "cum_inc"</code> refer to the cumulative incidence, i.e. the circumcision coverage.</li>
</ul>
<p>These sample matrices have <code>N</code> columns, and their rows match up with the rows in <code>out</code>, <strong>for the modelled <code>area_lev</code></strong> (so not at lower area levels). We can use the function <code>compute_quantiles</code> to compute lower, middle and upper quantiles (default <code>c(0.025, 0.5, 0.975)</code>, but can be changed by specifying the <code>probs</code> argument) for the samples for each row in <code>out</code> (that has <code>area_level == area_lev</code> (five)).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># subset to specific area level and calculate quantiles for rates and hazard</span></span>
<span><span class="va">out_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_quantiles.html">compute_quantiles</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">fit</span>, area_lev <span class="op">=</span> <span class="va">area_lev</span><span class="op">)</span></span>
<span></span>
<span><span class="va">out_spec</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="co"># remove observed circ rate cols we already know about</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">N</span><span class="op">:</span><span class="va">icens</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 39</span></span></span>
<span><span class="co">#&gt;   area_id  area_name area_level space  year circ_age  time   age popul…¹ rate_…²</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> MWI_5_01 Chitipa            5    67  <span style="text-decoration: underline;">2</span>008        0     1     1   <span style="text-decoration: underline;">3</span>764. 3.69<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> MWI_5_01 Chitipa            5    67  <span style="text-decoration: underline;">2</span>009        0     2     1   <span style="text-decoration: underline;">3</span>839. 4.42<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> MWI_5_01 Chitipa            5    67  <span style="text-decoration: underline;">2</span>010        0     3     1   <span style="text-decoration: underline;">3</span>880. 1.24<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> MWI_5_01 Chitipa            5    67  <span style="text-decoration: underline;">2</span>011        0     4     1   <span style="text-decoration: underline;">3</span>901. 1.33<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> MWI_5_01 Chitipa            5    67  <span style="text-decoration: underline;">2</span>012        0     5     1   <span style="text-decoration: underline;">3</span>917. 4.97<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> MWI_5_01 Chitipa            5    67  <span style="text-decoration: underline;">2</span>013        0     6     1   <span style="text-decoration: underline;">3</span>926. 2.51<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 29 more variables: rate_mmcM &lt;dbl&gt;, rate_mmcU &lt;dbl&gt;, rate_tmcL &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   rate_tmcM &lt;dbl&gt;, rate_tmcU &lt;dbl&gt;, rateL &lt;dbl&gt;, rateM &lt;dbl&gt;, rateU &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   survL &lt;dbl&gt;, survM &lt;dbl&gt;, survU &lt;dbl&gt;, inc_mmcL &lt;dbl&gt;, inc_mmcM &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   inc_mmcU &lt;dbl&gt;, inc_tmcL &lt;dbl&gt;, inc_tmcM &lt;dbl&gt;, inc_tmcU &lt;dbl&gt;, incL &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   incM &lt;dbl&gt;, incU &lt;dbl&gt;, cum_inc_mmcL &lt;dbl&gt;, cum_inc_mmcM &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   cum_inc_mmcU &lt;dbl&gt;, cum_inc_tmcL &lt;dbl&gt;, cum_inc_tmcM &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   cum_inc_tmcU &lt;dbl&gt;, cum_incL &lt;dbl&gt;, cum_incM &lt;dbl&gt;, cum_incU &lt;dbl&gt;, and …</span></span></span></code></pre></div>
<!-- out_spec <- readr::read_csv("./MWI_Results_DistrictAgeTime_ByType.csv.gz") -->
<p>The lower, middle and upper quartiles are labelled with “L”, “M” and “U”, respectively.</p>
<p>You can now save <code>fit</code> as an <code>.RData</code> file using <code>save</code>. However, this file is often very large (&gt; 1GB). We can make the <code>fit</code> object much smaller using <code>minimise_fit_obj</code>, which just stores your <code>dat_tmb</code> and <code>parameters</code> in <code>fit</code> (under the names <code>tmb_data</code> and <code>par_init</code>, respectively) and removes <code>fit$sample</code> and <code>fit$obj</code>. This object is much smaller, and can be saved using <code>saveRDS</code> as an <code>.rds</code> file. The downside is that if we want to reload our <code>fit_min</code> at a later time, we must re-sample. However, this can be easily done using <code>threemc_fit_model</code> and supplying <code>fit_min</code> as the <code>fit</code> argument. This is treated with greater detail in the aggregation vignette.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># minimise fit object for saving</span></span>
<span><span class="va">fit_min</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/minimise_fit_obj.html">minimise_fit_obj</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">dat_tmb</span>, <span class="va">parameters</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fit_min</span><span class="op">)</span> <span class="co"># no "sample" or "obj", but has "tmb_data" and "par_init"</span></span>
<span><span class="co">#&gt;  [1] "par"         "objective"   "convergence" "iterations"  "evaluations"</span></span>
<span><span class="co">#&gt;  [6] "message"     "par.fixed"   "par.full"    "tmb_data"    "par_init"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="interpretation">Interpretation<a class="anchor" aria-label="anchor" href="#interpretation"></a>
</h2>
<p>We can have a quick look at our model predictions by plotting some of our results. For the sake of brevity, we won’t go (too much) into differences in circumcision type here, and only look at total circumcision (MC). We’ll also have to cheat a little bit and look at only a subset of our modelled region, in order for the plots in this vignette to be readable when exported to HTML.</p>
<p>First, we look at circumcision rate for each “Health District + Cities” modelled for different (circumcision) ages. We also include several years to observe any changes over time.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># remove some years to show change more clearly</span></span>
<span><span class="va">out_plot</span> <span class="op">&lt;-</span> <span class="va">out_spec</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="va">start_year</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="op">(</span><span class="va">start_year</span> <span class="op">+</span> <span class="va">forecast_year</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>, <span class="va">forecast_year</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="va">area_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"Blantyre"</span>, <span class="st">"Blantyre City"</span>, <span class="st">"Lilongwe"</span>, </span>
<span>      <span class="st">"Lilongwe City"</span>, <span class="st">"Machinga"</span>, <span class="st">"Mangochi"</span>, <span class="st">"Mzimba North"</span>, </span>
<span>      <span class="st">"Mzimba South"</span>, <span class="st">"Zomba City"</span> <span class="co">#  "Chiradzulu", "Mzuzu City", "Zomba"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="va">out_plot</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">age</span>,</span>
<span>    y <span class="op">=</span> <span class="va">rateM</span>,</span>
<span>    ymin <span class="op">=</span> <span class="va">rateL</span>,</span>
<span>    ymax <span class="op">=</span> <span class="va">rateU</span>,</span>
<span>    group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>,</span>
<span>    colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"lightgrey"</span>, colour <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># facet_wrap(. ~ area_name, ncol = 4) + </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">area_name</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Age"</span>, y <span class="op">=</span> <span class="st">"Rates"</span>, colour <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html" class="external-link">label_percent</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    axis.text.x      <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    axis.title.x     <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>    axis.text.y      <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    axis.title.y     <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>    legend.text      <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    legend.position  <span class="op">=</span> <span class="st">"bottom"</span>,  <span class="co"># place legend on bottom</span></span>
<span>    strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, colour <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="co"># col facets</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use `linewidth` instead.</span></span></code></pre></div>
<p><img src="01_intro_files/figure-html/plot_rates-1.png" width="100%" height="100%"></p>
<p>There is significant spatial heterogeneity in circumcision practises. However, we can see that there is not much heterogeneity when it comes to circumcision age, with the MC rate highest among those aged around 10-13 for every area with less than negligible circumcision. Circumcisions do not seem to occur for those over 30s.</p>
<p>In many areas (such as Lilongwe), there doesn’t seem to be a great number of circumcisions being performed. Perhaps this is because circumcision is already high in these regions. However, this may be unlikely, as traditional circumcision (the main reason for high circumcision in Malawi pre-2012 (the year they began implementing Voluntary Male Medical Circumcision (VMMC) programmes <span class="citation">[4]</span>)) is generally low in these regions (this can easily be plotted using <code>rate_tmc</code>).</p>
<p>Also, circumcision rates have increased quite significantly in many regions since 2008. However, in some (such as Blantyre City and Machinga), MC rates have slowed in 2021 (for which we have no survey data and must forecast out-of-sample) vs 2015, indicating that circumcision coverage may have become quite high and started to “taper-off” there.</p>
<p>It’s also obviously a good idea to look at circumcision coverage to help support or reject our theories, and give additional insight.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="va">out_plot</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">age</span>,</span>
<span>    y <span class="op">=</span> <span class="va">cum_incM</span>,</span>
<span>    ymin <span class="op">=</span> <span class="va">cum_incL</span>,</span>
<span>    ymax <span class="op">=</span> <span class="va">cum_incU</span>,</span>
<span>    group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>,</span>
<span>    colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"lightgrey"</span>, colour <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">area_name</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Age"</span>, y <span class="op">=</span> <span class="st">"Coverage"</span>, colour <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html" class="external-link">label_percent</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    axis.text.x      <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    axis.title.x     <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>    axis.text.y      <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    axis.title.y     <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>    legend.text      <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    legend.position  <span class="op">=</span> <span class="st">"bottom"</span>,  </span>
<span>    strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, colour <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> </span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="01_intro_files/figure-html/plot_coverage-1.png" width="100%" height="100%"></p>
<p>Here we can see the high MC rates amongst younger individuals reflected in the age-distribution of circumcision coverage in many of these same regions, which seems to “peak” at slightly older teenage years (around 17-19).</p>
<p>In Lilongwe and other regions with “flat” MC rates in our previous plot, we unfortunately learn that circumcision coverage is very low.</p>
<p>Circumcision coverage is greater than or the same in every region from 2008 to 2015 and from 2015 to 2021 (however, this is one of the assumptions of <code>threemc</code>, that MC is cumulative thus monotonically increasing).</p>
<p>In those regions where we observed some “tapering off” in circumcision rates, we can see that coverage is indeed high. In particular, Machinga and Mangochi have had consistently high coverage across our predictive period, suggesting that TMC is high there. Blantyre City and Lilongwe City, which have high HIV burdens <span class="citation">[5]</span> and had very low coverage in 2008, have seen significant (forecasted) increases in circumcision levels, highlighting the work being done in resource allocation, which motivates this model (this perhaps also suggests a greater ease in implementing circumcision programmes in urban areas in Malawi).</p>
</div>
<div class="section level2">
<h2 id="conclusions">Conclusions<a class="anchor" aria-label="anchor" href="#conclusions"></a>
</h2>
<p>We have fitted a <code>threemc</code> model to Malawi’s “Health District and Cities”, and interpreted our results (which, again, are <strong>not to be taken as genuine forecasts for Malawi</strong>). Hopefully this vignette can empower you to fit <code>threemc</code> to your own data!</p>
<p>We can also aggregate these results to less granular regions, producing estimates for each of Malawi’s five area levels, including at the national level. This is the focus of the next vignette.</p>
<p>There are also several variations on the “default” <code>threemc</code> model used here. As mentioned previously, these include having a fixed paediatric MMC rate, a time effect for TMC, and using RW temporal priors. These alternative models are also addressed in another vignette.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs">
<div id="ref-thomas_multi-level_2021">
<p>1. Thomas ML, Zuma K, Loykissoonlal D, Dube B, Vranken P, Porter SE, et al. A multi-level model for estimating region-age-time-type specific male circumcision coverage from household survey and health system data in South Africa. arXiv; 2021. Available: <a href="http://arxiv.org/abs/2108.09142" class="external-link">http://arxiv.org/abs/2108.09142</a></p>
</div>
<div id="ref-kristensen_tmb_2016">
<p>2. Kristensen K, Nielsen A, Berg CW, Skaug H, Bell B. TMB: Automatic Differentiation and Laplace Approximation. Journal of Statistical Software. 2016;70. doi:<a href="https://doi.org/10.18637/jss.v070.i05" class="external-link">10.18637/jss.v070.i05</a></p>
</div>
<div id="ref-eaton_naomi_2021">
<p>3. Eaton JW, Dwyer-Lindgren L, Gutreuter S, O’Driscoll M, Stevens O, Bajaj S, et al. Naomi: A new modelling tool for estimating HIV epidemic indicators at the district level in sub-Saharan Africa. Journal of the International AIDS Society. 2021;24: e25788. doi:<a href="https://doi.org/10.1002/jia2.25788" class="external-link">10.1002/jia2.25788</a></p>
</div>
<div id="ref-matoga_uptake_2022">
<p>4. Matoga MM, Hosseinipour MC, Jewett S, Chasela C. Uptake of voluntary medical male circumcision among men with sexually transmitted infections in Lilongwe, Malawi: A protocol for a pre-interventional and post-interventional study. BMJ Open. 2022;12: e057507. doi:<a href="https://doi.org/10.1136/bmjopen-2021-057507" class="external-link">10.1136/bmjopen-2021-057507</a></p>
</div>
<div id="ref-nutor_spatial_2020">
<p>5. Nutor JJ, Duah HO, Agbadi P, Duodu PA, Gondwe KW. Spatial analysis of factors associated with HIV infection in Malawi: Indicators for effective prevention. BMC Public Health. 2020;20: 1167. doi:<a href="https://doi.org/10.1186/s12889-020-09278-0" class="external-link">10.1186/s12889-020-09278-0</a></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Matthew Thomas, Jeffrey Eaton, Patrick O’Toole.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
